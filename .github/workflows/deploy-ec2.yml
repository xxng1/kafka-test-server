name: Deploy Django to EC2

on:
  workflow_dispatch:   # 수동 실행
  # 또는 release 이벤트 사용
  # release:
  #   types: [published]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
    - name: Deploy to EC2
      run: |
        echo "${{ secrets.EC2_KEY }}" | base64 -d > ec2-key.pem
        chmod 600 ec2-key.pem

        ssh -o StrictHostKeyChecking=no -i ec2-key.pem ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'EOF'
          
          # ECR 정보 설정
          AWS_REGION=${{ secrets.AWS_REGION }}
          ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)

          # ECR 로그인
          aws ecr get-login-password --region $AWS_REGION | \
            docker login --username AWS --password-stdin $ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com

          # 이미지 풀 & 실행
          IMAGE_URI=$ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com/${{ secrets.ECR_REPOSITORY }}:latest

          sudo docker pull \$IMAGE_URI
          sudo docker stop django-container || true
          sudo docker rm django-container || true
          sudo docker run -d \
            --name django-container \
            -p 80:80 \
            \$IMAGE_URI
        EOF
          
          